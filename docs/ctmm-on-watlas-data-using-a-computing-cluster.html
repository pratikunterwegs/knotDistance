<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement</title>
  <meta name="description" content="2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement" />
  <meta name="github-repo" content="pratikunterwegs/knotDistance" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement" />
  
  <meta name="twitter:description" content="2 CTMM on WATLAS data using a computing cluster | Linking experimental measures of personality to free-living movement" />
  

<meta name="author" content="Pratik R Gupte" />


<meta name="date" content="2020-03-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="applying-ctmm-to-watlas-data.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<script src="libs/elevate-section-attrs-2.0/elevate-section-attrs.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#attribution"><i class="fa fa-check"></i><b>1.1</b> Attribution</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-access"><i class="fa fa-check"></i><b>1.2</b> Data access</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#data-processing"><i class="fa fa-check"></i><b>1.3</b> Data processing</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ctmm-on-watlas-data-using-a-computing-cluster.html"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html"><i class="fa fa-check"></i><b>2</b> CTMM on WATLAS data using a computing cluster</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ctmm-on-watlas-data-using-a-computing-cluster.html"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#load-libraries"><i class="fa fa-check"></i><b>2.1</b> Load libraries</a></li>
<li class="chapter" data-level="2.2" data-path="ctmm-on-watlas-data-using-a-computing-cluster.html"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#load-prelim-data"><i class="fa fa-check"></i><b>2.2</b> Load prelim data</a></li>
<li class="chapter" data-level="2.3" data-path="ctmm-on-watlas-data-using-a-computing-cluster.html"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#choose-scales-of-aggregation"><i class="fa fa-check"></i><b>2.3</b> Choose scales of aggregation</a></li>
<li class="chapter" data-level="2.4" data-path="ctmm-on-watlas-data-using-a-computing-cluster.html"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#transfer-data-and-process-on-cluster"><i class="fa fa-check"></i><b>2.4</b> Transfer data and process on cluster</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html"><i class="fa fa-check"></i><b>3</b> Applying CTMM to WATLAS data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#load-libraries-1"><i class="fa fa-check"></i><b>3.1</b> Load libraries</a></li>
<li class="chapter" data-level="3.2" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#load-prelim-data-1"><i class="fa fa-check"></i><b>3.2</b> Load prelim data</a></li>
<li class="chapter" data-level="3.3" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#choose-scales-of-aggregation-1"><i class="fa fa-check"></i><b>3.3</b> Choose scales of aggregation</a></li>
<li class="chapter" data-level="3.4" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#transfer-data-and-process-on-cluster-1"><i class="fa fa-check"></i><b>3.4</b> Transfer data and process on cluster</a></li>
<li class="chapter" data-level="3.5" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#get-speed-estimates-from-cluster"><i class="fa fa-check"></i><b>3.5</b> Get speed estimates from cluster</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#plot-speed-at-different-scales"><i class="fa fa-check"></i><b>3.5.1</b> Plot speed at different scales</a></li>
<li class="chapter" data-level="3.5.2" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#plot-speed-in-relation-to-proportion-of-positions"><i class="fa fa-check"></i><b>3.5.2</b> Plot speed in relation to proportion of positions</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#get-instantaneous-speed-estimates"><i class="fa fa-check"></i><b>3.6</b> Get instantaneous speed estimates</a></li>
<li class="chapter" data-level="3.7" data-path="applying-ctmm-to-watlas-data.html"><a href="applying-ctmm-to-watlas-data.html#comparing-sld-and-ctmm"><i class="fa fa-check"></i><b>3.7</b> Comparing SLD and CTMM</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Linking experimental measures of personality to free-living movement</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ctmm-on-watlas-data-using-a-computing-cluster" class="section level1">
<h1 number="2"><span class="header-section-number">2</span> CTMM on WATLAS data using a computing cluster</h1>
<p>This section is about running CTMM <span class="citation">(<span class="citeproc-not-found" data-reference-id="calabrese2016"><strong>???</strong></span>)</span> on individual level movement data to calculate mean speeds and total distance travelled.
CTMM is a time intensive process taking <em>n log(n)</em> seconds for <em>n</em> positions (pers. comm. Mike Noonan).
We circumvent the obvious time cost by sending each individualâ€™s track to the RUG computing cluster for processing.</p>
<p>Methodologically, we read in raw, unprocessed data, remove so-called attractor points, and then clean the data by applying a 5-fix median filter.
We identify tidal cycles using data from Rijkswaterstaat, and split movement tracks into subsets lasting from one high tide to the next.
Treating these subsets as individual replicates in a population, as recommended <span class="citation">(<span class="citeproc-not-found" data-reference-id="calabrese2016"><strong>???</strong></span>)</span>, we guess CTMM parameters and fit CTMM to each tidal cycle.
Finally, we output the fitted models and their summaries as <code>.Rdata</code> and text files, respectively.</p>
<p>Much of the preliminary processing also happens on the cluster, and uses the the <a href="https://github.com/pratikunterwegs/watlasUtils">WATLAS Utilities package</a>.</p>
<p><strong>Workflow</strong></p>
<ol style="list-style-type: decimal">
<li>Prepare required libraries.</li>
<li>Read in data, apply the cleaning function, and overwrite local data.</li>
</ol>
<div id="load-libraries" class="section level2">
<h2 number="2.1"><span class="header-section-number">2.1</span> Load libraries</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-1"></a><span class="co"># load libs</span></span>
<span id="cb1-2"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-2"></a><span class="kw">library</span>(data.table)</span>
<span id="cb1-3"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-3"></a><span class="kw">library</span>(glue)</span>
<span id="cb1-4"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-4"></a><span class="kw">library</span>(stringr)</span>
<span id="cb1-5"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-5"></a><span class="kw">library</span>(tibble)</span>
<span id="cb1-6"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-6"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb1-7"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-7"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb1-8"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-8"></a><span class="kw">library</span>(forcats)</span>
<span id="cb1-9"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-9"></a></span>
<span id="cb1-10"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-10"></a><span class="co"># plot libs</span></span>
<span id="cb1-11"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-11"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-12"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-12"></a><span class="kw">library</span>(ggthemes)</span>
<span id="cb1-13"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-13"></a><span class="kw">library</span>(scico)</span>
<span id="cb1-14"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-14"></a></span>
<span id="cb1-15"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-15"></a><span class="co"># ssh func</span></span>
<span id="cb1-16"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb1-16"></a><span class="kw">library</span>(ssh)</span></code></pre></div>
</div>
<div id="load-prelim-data" class="section level2">
<h2 number="2.2"><span class="header-section-number">2.2</span> Load prelim data</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-1"></a><span class="co"># load data</span></span>
<span id="cb2-2"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-2"></a><span class="co"># make a list of data files to read</span></span>
<span id="cb2-3"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-3"></a>data_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="st">&quot;data/watlas&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;whole_season*&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb2-4"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-4"></a></span>
<span id="cb2-5"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-5"></a>data_ids &lt;-<span class="st"> </span><span class="kw">str_extract</span>(data_files, <span class="st">&quot;(tx_</span><span class="ch">\\</span><span class="st">d+)&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_sub</span>(<span class="op">-</span><span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-6"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-6"></a></span>
<span id="cb2-7"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-7"></a><span class="co"># read deployment data from local file in data folder</span></span>
<span id="cb2-8"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-8"></a>tag_info &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/SelinDB.csv&quot;</span>)</span>
<span id="cb2-9"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-9"></a></span>
<span id="cb2-10"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-10"></a><span class="co"># filter out NAs in release date and time</span></span>
<span id="cb2-11"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-11"></a>tag_info &lt;-<span class="st"> </span>tag_info[<span class="op">!</span><span class="kw">is.na</span>(Release_Date) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Release_Time),]</span>
<span id="cb2-12"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-12"></a></span>
<span id="cb2-13"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-13"></a><span class="co"># make release date column as POSIXct</span></span>
<span id="cb2-14"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-14"></a>tag_info[,Release_Date <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="kw">paste</span>(Release_Date, Release_Time, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>), </span>
<span id="cb2-15"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-15"></a>                                     <span class="dt">format =</span> <span class="st">&quot;%d.%m.%y %H:%M&quot;</span>, <span class="dt">tz =</span> <span class="st">&quot;CET&quot;</span>)]</span>
<span id="cb2-16"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-16"></a></span>
<span id="cb2-17"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-17"></a><span class="co"># sub for knots in data</span></span>
<span id="cb2-18"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-18"></a>data_files &lt;-<span class="st"> </span>data_files[<span class="kw">as.integer</span>(data_ids) <span class="op">%in%</span><span class="st"> </span>tag_info<span class="op">$</span>Toa_Tag]</span>
<span id="cb2-19"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb2-19"></a>data_ids &lt;-<span class="st"> </span><span class="kw">str_extract</span>(data_files, <span class="st">&quot;(tx_</span><span class="ch">\\</span><span class="st">d+)&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_sub</span>(<span class="op">-</span><span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="choose-scales-of-aggregation" class="section level2">
<h2 number="2.3"><span class="header-section-number">2.3</span> Choose scales of aggregation</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb3-1"></a>scales &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>)</span>
<span id="cb3-2"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb3-2"></a></span>
<span id="cb3-3"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb3-3"></a>data_to_test &lt;-<span class="st"> </span><span class="kw">crossing</span>(scales, <span class="kw">nesting</span>(data_files, data_ids))</span>
<span id="cb3-4"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb3-4"></a><span class="kw">rm</span>(scales, data_files)</span></code></pre></div>
</div>
<div id="transfer-data-and-process-on-cluster" class="section level2">
<h2 number="2.4"><span class="header-section-number">2.4</span> Transfer data and process on cluster</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-1"></a><span class="co"># read password</span></span>
<span id="cb4-2"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-2"></a>password =<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;data/password.txt&quot;</span>)<span class="op">$</span>password</span>
<span id="cb4-3"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-3"></a></span>
<span id="cb4-4"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-4"></a><span class="co"># transfer code files</span></span>
<span id="cb4-5"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-5"></a>{</span>
<span id="cb4-6"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-6"></a>  s &lt;-<span class="st"> </span><span class="kw">ssh_connect</span>(<span class="st">&quot;p284074@peregrine.hpc.rug.nl&quot;</span>, <span class="dt">passwd =</span> password)</span>
<span id="cb4-7"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-7"></a>  rfiles &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;code&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;.r&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-8"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-8"></a>  <span class="kw">scp_upload</span>(s, rfiles, <span class="dt">to =</span> <span class="st">&quot;code/&quot;</span>)</span>
<span id="cb4-9"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-9"></a>  <span class="kw">ssh_disconnect</span>(s)</span>
<span id="cb4-10"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-10"></a>}</span>
<span id="cb4-11"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-11"></a></span>
<span id="cb4-12"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-12"></a><span class="co"># clear old speed estimates</span></span>
<span id="cb4-13"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-13"></a>{</span>
<span id="cb4-14"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-14"></a>  s &lt;-<span class="st"> </span><span class="kw">ssh_connect</span>(<span class="st">&quot;p284074@peregrine.hpc.rug.nl&quot;</span>, <span class="dt">passwd =</span> password)</span>
<span id="cb4-15"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-15"></a>  <span class="kw">ssh_exec_wait</span>(s, <span class="dt">command =</span> <span class="st">&quot;rm output/speed_estimates_2018.csv&quot;</span>)</span>
<span id="cb4-16"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-16"></a>  <span class="kw">ssh_disconnect</span>(s)</span>
<span id="cb4-17"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-17"></a>}</span>
<span id="cb4-18"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-18"></a></span>
<span id="cb4-19"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-19"></a><span class="co"># execute tests</span></span>
<span id="cb4-20"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-20"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(data_to_test)){</span>
<span id="cb4-21"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-21"></a>  </span>
<span id="cb4-22"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-22"></a>  scale &lt;-<span class="st"> </span>data_to_test<span class="op">$</span>scales[i]</span>
<span id="cb4-23"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-23"></a>  file &lt;-<span class="st"> </span>data_to_test<span class="op">$</span>data_files[i]</span>
<span id="cb4-24"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-24"></a>  id &lt;-<span class="st"> </span>data_to_test<span class="op">$</span>data_ids[i]</span>
<span id="cb4-25"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-25"></a>  <span class="co"># connect to peregrine</span></span>
<span id="cb4-26"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-26"></a>  s &lt;-<span class="st"> </span><span class="kw">ssh_connect</span>(<span class="st">&quot;p284074@peregrine.hpc.rug.nl&quot;</span>, <span class="dt">passwd =</span> password)</span>
<span id="cb4-27"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-27"></a>  <span class="co"># make directory if non-existent</span></span>
<span id="cb4-28"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-28"></a>  <span class="kw">ssh_exec_wait</span>(s, <span class="dt">command =</span> <span class="st">&quot;mkdir -p data/watlas&quot;</span>)</span>
<span id="cb4-29"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-29"></a>  </span>
<span id="cb4-30"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-30"></a>  <span class="co"># list files already present</span></span>
<span id="cb4-31"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-31"></a>  files_on_prg &lt;-<span class="st"> </span><span class="kw">ssh_exec_internal</span>(s, <span class="dt">command =</span> <span class="st">&quot;ls data/watlas&quot;</span>)</span>
<span id="cb4-32"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-32"></a>  files_on_prg &lt;-<span class="st"> </span><span class="kw">rawToChar</span>(files_on_prg<span class="op">$</span>stdout) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-33"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-33"></a><span class="st">    </span><span class="kw">str_split</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-34"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-34"></a><span class="st">    </span><span class="kw">unlist</span>()</span>
<span id="cb4-35"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-35"></a>  </span>
<span id="cb4-36"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-36"></a>  <span class="co"># check name</span></span>
<span id="cb4-37"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-37"></a>  data_name &lt;-<span class="st"> </span>file <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-38"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-38"></a><span class="st">    </span><span class="kw">str_split</span>(<span class="st">&quot;/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-39"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-39"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">3</span>]</span>
<span id="cb4-40"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-40"></a>  </span>
<span id="cb4-41"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-41"></a>  <span class="cf">if</span>(<span class="op">!</span>data_name <span class="op">%in%</span><span class="st"> </span>files_on_prg){</span>
<span id="cb4-42"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-42"></a>    <span class="co"># upload data file for processing</span></span>
<span id="cb4-43"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-43"></a>    <span class="kw">scp_upload</span>(s, file, <span class="dt">to =</span> <span class="st">&quot;data/watlas&quot;</span>)</span>
<span id="cb4-44"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-44"></a>  }</span>
<span id="cb4-45"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-45"></a>  </span>
<span id="cb4-46"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-46"></a>  <span class="co"># make job file</span></span>
<span id="cb4-47"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-47"></a>  {</span>
<span id="cb4-48"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-48"></a>    shebang &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;code/template_job.sh&quot;</span>)</span>
<span id="cb4-49"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-49"></a>    </span>
<span id="cb4-50"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-50"></a>    <span class="co"># rename job</span></span>
<span id="cb4-51"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-51"></a>    shebang[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">glue</span>(<span class="st">&#39;#SBATCH --job-name=ctmm_{file}&#39;</span>)</span>
<span id="cb4-52"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-52"></a>    </span>
<span id="cb4-53"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-53"></a>    text &lt;-<span class="st"> </span><span class="kw">glue</span>(<span class="st">&#39;Rscript --vanilla code/code_test_ctmm_scale.r {file} {scale}&#39;</span>)</span>
<span id="cb4-54"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-54"></a>    jobfile &lt;-<span class="st"> </span><span class="kw">glue</span>(<span class="st">&#39;code/job_ctmm_{id}_{scale}.sh&#39;</span>)</span>
<span id="cb4-55"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-55"></a>    </span>
<span id="cb4-56"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-56"></a>    <span class="kw">writeLines</span>(<span class="kw">c</span>(shebang, text), <span class="dt">con =</span> jobfile)</span>
<span id="cb4-57"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-57"></a>    <span class="kw">scp_upload</span>(s, jobfile, <span class="dt">to =</span> <span class="st">&quot;code/&quot;</span>)</span>
<span id="cb4-58"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-58"></a>  }</span>
<span id="cb4-59"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-59"></a>  </span>
<span id="cb4-60"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-60"></a>  <span class="kw">ssh_exec_wait</span>(s, <span class="dt">command =</span> <span class="kw">glue</span>(<span class="st">&#39;dos2unix {jobfile}&#39;</span>))</span>
<span id="cb4-61"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-61"></a>  <span class="co"># process using ctmm</span></span>
<span id="cb4-62"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-62"></a>  <span class="kw">ssh_exec_wait</span>(s, <span class="dt">command =</span> <span class="kw">glue</span>(<span class="st">&#39;sbatch {jobfile}&#39;</span>))</span>
<span id="cb4-63"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-63"></a>  </span>
<span id="cb4-64"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-64"></a>  <span class="co"># disconnect</span></span>
<span id="cb4-65"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-65"></a>  <span class="kw">ssh_disconnect</span>(s)</span>
<span id="cb4-66"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-66"></a>  </span>
<span id="cb4-67"><a href="ctmm-on-watlas-data-using-a-computing-cluster.html#cb4-67"></a>}</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="applying-ctmm-to-watlas-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/pratikunterwegs/knotDistance/edit/master/02_cleaning_data.rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
